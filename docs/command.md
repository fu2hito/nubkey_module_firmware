# nubkey_module　通信仕様

<br>
nubkey_module は AZ1UBALL 同様にPIM447と同じ通信でQMKなどから使用できます。<br>

<br><br>

## デフォルトのレスポンスフォーマット　(PIM447互換)
<br>

|  内容  |  説明  |  サイズ(byte)  |
|  --  |  --  |  --  |
|  移動距離  |  左方向への移動距離  |  1  |
|  移動距離  |  右方向への移動距離  |  1  |
|  移動距離  |  上方向への移動距離  |  1  |
|  移動距離  |  下方向への移動距離  |  1  |
|  スイッチ  |  0x00 = ボタン OFF<br>0x80 = ボタン ON  |  1  |


<br><br>


## QMK起動時にコマンドを実行する例
<br>
通常のレスポンスとは別にI2Cでコマンドを送信する事で細かい設定を行う事ができます。<br>
<br>

```
void pointing_device_init_kb(void) {
    // _delay_ms(100); // nubkey_module の起動よりもProMicroの起動のが早い場合用 nubkey_module の起動を待ってから設定コマンドを投げる
    uint8_t res[8];
    uint16_t timeout=100;
    i2c_status_t status;
    uint8_t addr=0x0A << 1;
    // 送信するコマンド
    uint8_t cmd[]={0x48,   /* 左 */ 0x03, 0xE8,   /* 右 */ 0x03, 0xE8,   /* 上 */ 0x03, 0xE8,   /* 下 */ 0x03, 0xE8}; // マウス移動の速度 左右上下
    // uint8_t cmd[]={0x47, 0x01, 0x68}; // 高さ調節
    // uint8_t cmd[]={0x4A}; // 設定リセット
    // コマンドの送信
    status  = i2c_transmit(addr, cmd, sizeof(cmd), timeout);
    if (status != 0) return;
    status = i2c_receive(addr, res, 1, timeout);
}
```

<br><br>


# I2C コマンド一覧


## 0x60　製品の情報取得

<b>■ 送信 ： 1 byte </b>
|  内容  |  説明  |  サイズ(byte)  |
|  --  |  --  |  --  |
|  コマンドタイプ  |  0x60 (固定)  |  1  |

<b>■ レスポンス ： 4 byte </b>
|  内容  |  説明  |  サイズ(byte)  |
|  --  |  --  |  --  |
|  コマンドのエコー  |  0x60（固定）  |  1  |
|  I2Cアドレス  |  nubkey_moduleのI2Cアドレス  |  1  |
|  製品番号  |  nubkey_moduleの識別番号（0x20 固定）  |  1  |
|  ファームウェアバージョン  |  使用されているファームウェアのバージョン  |  1  |

<br><br>


## 0x40　I2Cアドレスを変更する
nubkey_moduleのI2Cアドレスを変更して、nubkey_moduleを再起動します。<br>
<b>■ 送信 ： 2 byte </b>
|  内容  |  説明  |  サイズ(byte)  |
|  --  |  --  |  --  |
|  コマンドタイプ  |  0x40 (固定)  |  1  |
|  I2Cアドレス  |  変更後のI2Cアドレス<br>0x00 を指定した場合デフォルトの0x0A（0x0BピンがGNDに接続されていた場合0x0B）になります。<br>（デフォルト：　0x00）  |  1  |

<b>■ レスポンス ： 1 byte </b>
|  内容  |  説明  |  サイズ(byte)  |
|  --  |  --  |  --  |
|  コマンドのエコー  |  0x40（固定）  |  1  |

<br><br>


## 0x41　設定内容を取得する

<b>■ 送信 ： 1 byte </b>
|  内容  |  説明  |  サイズ(byte)  |
|  --  |  --  |  --  |
|  コマンドタイプ  |  0x41 (固定)  |  1  |

<b>■ レスポンス ： 23 byte </b>
|  内容  |  説明  |  サイズ(byte)  |
|  --  |  --  |  --  |
|  コマンドのエコー  |  0x41  |  1  |
|  I2Cアドレス  |  nubkey_moduleのI2Cアドレス  |  1  |
|  nubkey_off_status  |  Nubkey_offにするかどうか<br>(0=Nubkey OFF / 1=Nubkey ON / 2=ピンの情報優先)  |  1  |
|  key_actuation  |  Nubkey_off時のアクチュエーションポイント  |  2  |
|  nub_start_time  |  Nubkeyとしてマウス操作させるまでの時間(ミリ秒)  |  2  |
|  nub_start_down  |  Nubkey マウス移動開始させるアクチュエーションポイント  |  2  |
|  nub_speed_left  |  Nubkey マウス移動させる速度 左  |  2  |
|  nub_speed_right  |  Nubkey マウス移動させる速度 右  |  2  |
|  nub_speed_up  |  Nubkey マウス移動させる速度 上  |  2  |
|  nub_speed_down  |  Nubkey マウス移動させる速度 下  |  2  |
|  rang_x  |  キャリブレーション中心の X 座標  |  2  |
|  rang_y  |  キャリブレーション中心の Y 座標  |  2  |
|  loop_delay  |  入力読み込みサイクルのdelay値(ミリ秒)  |  2  |

<br><br>


## 0x42　Nubkey OFF モードの設定
Nubkey OFF モードを設定して EEPROM に保存します。<br>
<b>■ 送信 ： 2 byte </b>
|  内容  |  説明  |  サイズ(byte)  |
|  --  |  --  |  --  |
|  コマンドタイプ  |  0x42 (固定)  |  1  |
|  モード  |  0=NubkeyOFFモード OFF<br>1=NubkeyOFFモード ON<br>2=ピンの情報優先（デフォルト）  |  1  |

<b>■ レスポンス ： 1 byte </b>
|  内容  |  説明  |  サイズ(byte)  |
|  --  |  --  |  --  |
|  コマンドのエコー  |  0x42  |  1  |

<br><br>


## 0x43　アクチュエーション設定モードの設定
アクチュエーション設定モードの設定。<br>
このコマンドを投げるのとactuationピンをGNDに接続するのと同等の制御ができます。<br>
<b>■ 送信 ： 2 byte </b>
|  内容  |  説明  |  サイズ(byte)  |
|  --  |  --  |  --  |
|  コマンドタイプ  |  0x43 (固定)  |  1  |
|  モード  |  0=アクチュエーション設定モード OFF<br>1=アクチュエーション設定モード ON<br>2=ピンの情報優先(デフォルト)  |  1  |

<b>■ レスポンス ： 1 byte </b>
|  内容  |  説明  |  サイズ(byte)  |
|  --  |  --  |  --  |
|  コマンドのエコー  |  0x43  |  1  |

<br><br>


## 0x44　キャリブレーション設定モードの設定
キャリブレーション設定モードの設定。<br>
このコマンドを投げるのとcalibrationピンをGNDに接続するのと同等の制御ができます。<br>
<b>■ 送信 ： 2 byte </b>
|  内容  |  説明  |  サイズ(byte)  |
|  --  |  --  |  --  |
|  コマンドタイプ  |  0x44 (固定)  |  1  |
|  モード  |  0=キャリブレーション設定モード OFF<br>1=キャリブレーション設定モード ON<br>2=ピンの情報優先(デフォルト)  |  1  |

<b>■ レスポンス ： 1 byte </b>
|  内容  |  説明  |  サイズ(byte)  |
|  --  |  --  |  --  |
|  コマンドのエコー  |  0x44  |  1  |

<br><br>


## 0x45　アクチュエーションポイント設定
アクチュエーションポイント設定してEEPROMに保存します。<br>
※ このアクチュエーションポイントは Nubkey OFF モードの時に使用されます。<br>
<b>■ 送信 ： 3 byte </b>
|  内容  |  説明  |  サイズ(byte)  |
|  --  |  --  |  --  |
|  コマンドタイプ  |  0x45 (固定)  |  1  |
|  アクチュエーションポイント  |  キーをONにする高さを指定<br>ここで指定した高さを下回るとキーがONになります。<br>（デフォルト：　280）  |  2  |

<b>■ レスポンス ： 1 byte </b>
|  内容  |  説明  |  サイズ(byte)  |
|  --  |  --  |  --  |
|  コマンドのエコー  |  0x45  |  1  |

<br><br>


## 0x46　Nubkey 開始までの時間を設定
Nubkeyとしてマウス操作させるまでの時間を更新してEEPROMに保存します。<br>
ここで指定した時間より短い時間でキーを離すと、タップ判定となりキーONが送信されます。<br>
<b>■ 送信 ： 2 byte </b>
|  内容  |  説明  |  サイズ(byte)  |
|  --  |  --  |  --  |
|  コマンドタイプ  |  0x46 (固定)  |  1  |
|  時間  |  Nubkey 開始までの時間（ミリ秒）（デフォルト：　200）  |  2  |

<b>■ レスポンス ： 1 byte </b>
|  内容  |  説明  |  サイズ(byte)  |
|  --  |  --  |  --  |
|  コマンドのエコー  |  0x46  |  1  |

<br><br>


## 0x47　Nubkey を動かし始める高さを設定
Nubkey 動かし始める高さを変更してEEPROMに保存します。<br>
<b>■ 送信 ： 3 byte </b>
|  内容  |  説明  |  サイズ(byte)  |
|  --  |  --  |  --  |
|  コマンドタイプ  |  0x47 (固定)  |  1  |
|  高さ  |  200～400　（デフォルト：　360）  |  2  |

<b>■ レスポンス ： 1 byte </b>
|  内容  |  説明  |  サイズ(byte)  |
|  --  |  --  |  --  |
|  コマンドのエコー  |  0x47  |  1  |

<br><br>

## 0x48　Nubkey マウス移動の速度設定
Nubkeyとしてマウス操作させる速度を更新してEEPROMに保存します。<br>
数値が小さいほど早く動きます。<br>
<b>■ 送信 ： 9 byte </b>
|  内容  |  説明  |  サイズ(byte)  |
|  --  |  --  |  --  |
|  コマンドタイプ  |  0x48 (固定)  |  1  |
|  移動速度 左  |  移動速度　(デフォルト：　800)  |  2  |
|  移動速度 右  |  移動速度　(デフォルト：　800)  |  2  |
|  移動速度 上  |  移動速度　(デフォルト：　600)  |  2  |
|  移動速度 下  |  移動速度　(デフォルト：　600)  |  2  |

<b>■ レスポンス ： 1 byte </b>
|  内容  |  説明  |  サイズ(byte)  |
|  --  |  --  |  --  |
|  コマンドのエコー  |  0x48  |  1  |

<br><br>


## 0x49　Nubkey 読み込みサイクルのdelay値設定
Nubkey 読み込みサイクルのdelay値を変更してEEPROMに保存します。<br>
<b>■ 送信 ： 3 byte </b>
|  内容  |  説明  |  サイズ(byte)  |
|  --  |  --  |  --  |
|  コマンドタイプ  |  0x49 (固定)  |  1  |
|  時間  |  停止する時間（ミリ秒）（デフォルト 2）  |  2  |

<b>■ レスポンス ： 1 byte </b>
|  内容  |  説明  |  サイズ(byte)  |
|  --  |  --  |  --  |
|  コマンドのエコー  |  0x49  |  1  |

<br><br>


## 0x4A　設定を全てリセットして再起動
<b>■ 送信 ： 1 byte </b>
|  内容  |  説明  |  サイズ(byte)  |
|  --  |  --  |  --  |
|  コマンドタイプ  |  0x4A (固定)  |  1  |

<b>■ レスポンス ： 1 byte </b>
|  内容  |  説明  |  サイズ(byte)  |
|  --  |  --  |  --  |
|  コマンドのエコー  |  0x4A  |  1  |

<br><br>


## 0x50　Nubkey のアナログ情報を取得
<b>■ 送信 ： 1 byte </b>
|  内容  |  説明  |  サイズ(byte)  |
|  --  |  --  |  --  |
|  コマンドタイプ  |  0x50 (固定)  |  1  |

<b>■ レスポンス ： 7 byte </b>
|  内容  |  説明  |  サイズ(byte)  |
|  --  |  --  |  --  |
|  コマンドのエコー  |  0x50  |  1  |
|  X座標  |  Nubkey の現在のX座標  |  2  |
|  Y座標  |  Nubkey の現在のY座標  |  2  |
|  高さ  |  キーの押し込み現在の高さ  |  2  |

<br><br>


## 0x51　ホールセンサーの情報を取得
<b>■ 送信 ： 1 byte </b>
|  内容  |  説明  |  サイズ(byte)  |
|  --  |  --  |  --  |
|  コマンドタイプ  |  0x51 (固定)  |  1  |

<b>■ レスポンス ： 9 byte </b>
|  内容  |  説明  |  サイズ(byte)  |
|  --  |  --  |  --  |
|  コマンドのエコー  |  0x51  |  1  |
|  アナログ値  |  ホールセンサーのアナログ値 上  |  2  |
|  アナログ値  |  ホールセンサーのアナログ値 下  |  2  |
|  アナログ値  |  ホールセンサーのアナログ値 左  |  2  |
|  アナログ値  |  ホールセンサーのアナログ値 右  |  2  |

<br><br>


